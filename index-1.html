<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interview Assistant ‚Äî Universal</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f2ee;
    --surface: #ffffff;
    --surface2: #faf8f5;
    --border: #e8e2d9;
    --accent: #1a6b3c;
    --accent-light: #e8f5ee;
    --accent2: #c85c1a;
    --text: #1a1714;
    --muted: #7a7068;
    --listening: #dc2626;
    --listening-bg: #fef2f2;
    --serif: 'DM Serif Display', serif;
    --sans: 'Outfit', sans-serif;
    --mono: 'DM Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
  }

  /* SETUP OVERLAY */
  .setup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(245,242,238,0.97);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .setup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 36px 32px;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 8px 40px rgba(0,0,0,0.08);
  }

  .setup-card h2 {
    font-family: var(--serif);
    font-size: 28px;
    margin-bottom: 6px;
  }
  .setup-card h2 em { color: var(--accent); font-style: italic; }

  .setup-card p {
    color: var(--muted);
    font-size: 13px;
    margin-bottom: 28px;
    line-height: 1.6;
  }

  .setup-field {
    margin-bottom: 18px;
  }

  .setup-field label {
    display: block;
    font-size: 11px;
    font-family: var(--mono);
    letter-spacing: 0.08em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 7px;
  }

  .setup-field input,
  .setup-field textarea,
  .setup-field select {
    width: 100%;
    padding: 11px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--bg);
    font-family: var(--sans);
    font-size: 14px;
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
    line-height: 1.5;
  }

  .setup-field input:focus,
  .setup-field textarea:focus,
  .setup-field select:focus {
    border-color: var(--accent);
  }

  .setup-field textarea { resize: none; }

  .setup-start {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 12px;
    font-family: var(--sans);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: background 0.2s, transform 0.15s;
  }
  .setup-start:hover { background: #145e32; transform: translateY(-1px); }

  .setup-note {
    font-size: 11px;
    color: var(--muted);
    text-align: center;
    margin-top: 12px;
    font-family: var(--mono);
  }

  /* HEADER */
  header {
    position: relative;
    z-index: 1;
    padding: 16px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
  }

  .brand {
    display: flex;
    flex-direction: column;
  }

  .brand h1 {
    font-family: var(--serif);
    font-size: 20px;
    color: var(--text);
    line-height: 1;
  }
  .brand h1 em { color: var(--accent); font-style: italic; }

  .role-tag {
    font-size: 11px;
    color: var(--muted);
    font-family: var(--mono);
    margin-top: 3px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .change-role-btn {
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg);
    font-size: 11px;
    font-family: var(--mono);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
  }
  .change-role-btn:hover { border-color: var(--accent); color: var(--accent); }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 5px 13px;
    border-radius: 100px;
    border: 1px solid var(--border);
    font-size: 11px;
    font-family: var(--mono);
    color: var(--muted);
    background: var(--bg);
    transition: all 0.3s;
  }
  .status-pill.active {
    background: var(--listening-bg);
    border-color: var(--listening);
    color: var(--listening);
  }
  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--muted);
    transition: background 0.3s;
  }
  .status-pill.active .status-dot {
    background: var(--listening);
    animation: throb 1s infinite;
  }
  @keyframes throb {
    0%,100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); opacity: 0.6; }
  }

  /* MAIN */
  .app {
    position: relative;
    z-index: 1;
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 860px;
    width: 100%;
    margin: 0 auto;
    padding: 20px 16px;
    gap: 14px;
  }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.04);
  }

  .card-header {
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .card-label {
    font-size: 10px;
    font-family: var(--mono);
    letter-spacing: 0.1em;
    color: var(--muted);
    text-transform: uppercase;
  }

  /* TRANSCRIPT */
  .transcript-area {
    padding: 16px 18px;
    min-height: 78px;
    font-size: 17px;
    line-height: 1.6;
    font-family: var(--serif);
  }

  .placeholder-text {
    color: var(--muted);
    font-family: var(--sans);
    font-size: 13px;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .wave { display: flex; gap: 3px; align-items: center; }
  .wave span {
    display: block; width: 3px; border-radius: 2px;
    background: var(--listening);
    animation: wave 1s ease-in-out infinite;
  }
  .wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
  .wave span:nth-child(2) { height: 14px; animation-delay: 0.1s; }
  .wave span:nth-child(3) { height: 10px; animation-delay: 0.2s; }
  .wave span:nth-child(4) { height: 16px; animation-delay: 0.3s; }
  .wave span:nth-child(5) { height: 8px; animation-delay: 0.4s; }
  @keyframes wave {
    0%,100% { transform: scaleY(1); }
    50% { transform: scaleY(0.4); }
  }

  /* CONTROLS */
  .listen-controls {
    padding: 12px 18px;
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface2);
    border-top: 1px solid var(--border);
  }

  .listen-btn {
    flex: 1;
    padding: 13px;
    border-radius: 12px;
    border: none;
    font-family: var(--sans);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 9px;
  }
  .listen-btn.start { background: var(--accent); color: #fff; }
  .listen-btn.start:hover { background: #145e32; transform: translateY(-1px); }
  .listen-btn.stop {
    background: var(--listening); color: #fff;
    animation: breathe 2s infinite;
  }
  @keyframes breathe {
    0%,100% { box-shadow: 0 0 0 0 rgba(220,38,38,0.3); }
    50% { box-shadow: 0 0 0 8px rgba(220,38,38,0); }
  }

  .secondary-btn {
    padding: 13px 16px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .secondary-btn:hover { background: var(--bg); }

  /* MANUAL INPUT */
  .manual-area {
    display: none;
    padding: 0 18px 14px;
    flex-direction: column;
    gap: 8px;
  }
  .manual-area.visible { display: flex; }

  .manual-textarea {
    width: 100%;
    padding: 11px 13px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--bg);
    font-family: var(--sans);
    font-size: 14px;
    color: var(--text);
    resize: none;
    outline: none;
    line-height: 1.5;
    transition: border-color 0.2s;
  }
  .manual-textarea:focus { border-color: var(--accent); }

  .submit-btn {
    align-self: flex-end;
    padding: 8px 18px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-family: var(--sans);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }
  .submit-btn:hover { background: #145e32; }

  /* ANSWER */
  .answer-card { display: none; }
  .answer-card.visible { display: block; }

  .answer-loading {
    padding: 28px 18px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--muted);
    font-size: 13px;
  }
  .spinner {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .answer-body { display: none; }
  .answer-body.visible { display: block; }

  .key-points-box {
    padding: 16px 18px;
    border-bottom: 1px solid var(--border);
  }

  .box-label {
    font-size: 10px;
    font-family: var(--mono);
    letter-spacing: 0.1em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .key-points-box ul {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 7px;
  }

  .key-points-box ul li {
    display: flex;
    align-items: flex-start;
    gap: 9px;
    font-size: 13px;
    font-weight: 500;
    line-height: 1.5;
  }
  .key-points-box ul li::before {
    content: '‚Üí';
    color: var(--accent);
    font-family: var(--mono);
    flex-shrink: 0;
  }

  .full-answer-box {
    padding: 16px 18px;
  }

  .full-answer-box p {
    font-size: 14px;
    line-height: 1.8;
    color: var(--text);
  }

  .answer-footer {
    padding: 10px 18px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 7px;
    background: var(--surface2);
    flex-wrap: wrap;
  }

  .tag-btn {
    padding: 5px 12px;
    border-radius: 100px;
    border: 1px solid var(--border);
    font-size: 11px;
    font-family: var(--mono);
    color: var(--muted);
    background: var(--surface);
    cursor: pointer;
    transition: all 0.15s;
  }
  .tag-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* HISTORY */
  .history-list { max-height: 240px; overflow-y: auto; }

  .history-item {
    padding: 11px 18px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
  }
  .history-item:last-child { border-bottom: none; }
  .history-item:hover { background: var(--bg); }

  .history-q {
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
  }
  .history-meta { font-size: 10px; font-family: var(--mono); color: var(--muted); }
  .history-empty { padding: 20px 18px; font-size: 13px; color: var(--muted); text-align: center; font-style: italic; }

  /* TIPS */
  .tips-strip {
    padding: 10px 16px;
    background: var(--accent-light);
    border: 1px solid rgba(26,107,60,0.2);
    border-radius: 12px;
    font-size: 11px;
    color: var(--accent);
    font-family: var(--mono);
  }

  /* NO SUPPORT */
  .no-support {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 12px;
    color: #92400e;
    display: none;
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .fadein { animation: fadein 0.35s ease forwards; }
  @keyframes fadein {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<!-- ===== SETUP OVERLAY ===== -->
<div class="setup-overlay" id="setup-overlay">
  <div class="setup-card">
    <h2>Interview <em>Assistant</em></h2>
    <p>Fill in your details once ‚Äî the AI will tailor every answer to your specific role, skills, and experience level.</p>

    <div class="setup-field">
      <label>Job Position / Role Applying For *</label>
      <input type="text" id="s-role" placeholder="e.g. SEO Specialist, Accountant, Nurse, Software Developer..." />
    </div>

    <div class="setup-field">
      <label>Experience Level</label>
      <select id="s-level">
        <option value="Fresh Graduate (0-1 year experience)">Fresh Graduate (0-1 yr)</option>
        <option value="Junior (1-3 years experience)">Junior (1-3 yrs)</option>
        <option value="Mid-level (3-5 years experience)">Mid-level (3-5 yrs)</option>
        <option value="Senior (5+ years experience)">Senior (5+ yrs)</option>
      </select>
    </div>

    <div class="setup-field">
      <label>Your Key Skills / Experience (optional but recommended)</label>
      <textarea id="s-skills" rows="3" placeholder="e.g. WordPress, Yoast SEO, Google Analytics, Canva, MS Excel, Customer Service, etc."></textarea>
    </div>

    <div class="setup-field">
      <label>Interview Language</label>
      <select id="s-lang">
        <option value="English">English</option>
        <option value="Filipino / Tagalog">Filipino / Tagalog</option>
        <option value="Taglish (mix of English and Tagalog)">Taglish</option>
      </select>
    </div>

    <button class="setup-start" onclick="startApp()">Start Interview Session ‚Üí</button>
    <div class="setup-note">Press Spacebar anytime to start/stop listening</div>
  </div>
</div>

<!-- ===== HEADER ===== -->
<header>
  <div class="brand">
    <h1>Interview <em>Assistant</em></h1>
    <div class="role-tag" id="header-role">‚Äî</div>
  </div>
  <div class="header-right">
    <button class="change-role-btn" onclick="changeRole()">‚úèÔ∏è Change Role</button>
    <div class="status-pill" id="status-pill">
      <div class="status-dot"></div>
      <span id="status-text">Ready</span>
    </div>
  </div>
</header>

<!-- ===== APP ===== -->
<div class="app">

  <div class="no-support" id="no-support">
    ‚ö†Ô∏è Voice recognition requires Chrome browser. You can still type questions manually.
  </div>

  <!-- LISTEN CARD -->
  <div class="card">
    <div class="card-header">
      <span class="card-label">üéôÔ∏è Interviewer's Question</span>
      <span style="font-size:10px;font-family:var(--mono);color:var(--muted)" id="conf-badge"></span>
    </div>

    <div class="transcript-area" id="transcript-area">
      <span class="placeholder-text" id="placeholder-text">
        Press <strong>Start Listening</strong> then play the interviewer's voice near the mic...
      </span>
    </div>

    <div class="manual-area" id="manual-area">
      <textarea class="manual-textarea" id="manual-q" rows="2" placeholder="Type the interview question here..."></textarea>
      <button class="submit-btn" onclick="submitManual()">Generate Answer ‚Üí</button>
    </div>

    <div class="listen-controls">
      <button class="listen-btn start" id="listen-btn" onclick="toggleListening()">
        <span id="listen-icon">üéôÔ∏è</span>
        <span id="listen-label">Start Listening</span>
      </button>
      <button class="secondary-btn" onclick="toggleManual()">‚úèÔ∏è Type</button>
    </div>
  </div>

  <!-- ANSWER CARD -->
  <div class="card answer-card" id="answer-card">
    <div class="card-header">
      <span class="card-label">üí° Suggested Answer</span>
      <span style="font-size:10px;font-family:var(--mono);color:var(--muted)" id="q-num"></span>
    </div>

    <div class="answer-loading" id="answer-loading">
      <div class="spinner"></div>
      Generating your answer...
    </div>

    <div class="answer-body" id="answer-body">
      <div class="key-points-box">
        <div class="box-label">‚ö° Key Points</div>
        <ul id="key-points-list"></ul>
      </div>
      <div class="full-answer-box">
        <div class="box-label" style="color:var(--muted)">üìù Full Answer ‚Äî read this aloud</div>
        <p id="full-answer-text"></p>
      </div>
      <div class="answer-footer">
        <button class="tag-btn" onclick="regenerate()">‚Ü∫ Regenerate</button>
        <button class="tag-btn" onclick="copyAnswer()">‚éò Copy</button>
        <button class="tag-btn" onclick="nextQuestion()">Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- HISTORY CARD -->
  <div class="card">
    <div class="card-header">
      <span class="card-label">üìã Question History</span>
      <button onclick="clearHistory()" style="font-size:10px;font-family:var(--mono);color:var(--muted);background:none;border:none;cursor:pointer;">clear</button>
    </div>
    <div class="history-list" id="history-list">
      <div class="history-empty" id="history-empty">No questions yet.</div>
    </div>
  </div>

  <div class="tips-strip">
    üí° Tip: Use Chrome ¬∑ Allow microphone ¬∑ Smart listening ‚Äî auto-detects when interviewer finishes speaking ¬∑ Press Space to start/stop
  </div>

</div>

<script>
// ===== STATE =====
let profile = {};
let recognition = null;
let isListening = false;
let finalTranscript = '';
let interimBuffer = '';
let silenceTimer = null;
let minLengthTimer = null;
let history = [];
let qCount = 0;
let currentQuestion = '';
let currentAnswer = null;
let manualVisible = false;

// Smart silence detection config
const SILENCE_AFTER_SPEECH = 2800;   // ms to wait after last word before processing
const MIN_WORDS_TO_PROCESS = 4;      // minimum words before auto-processing
const MAX_WAIT_TIME = 18000;         // max 18 seconds of listening before forcing process

// ===== SETUP =====
function startApp() {
  const role = document.getElementById('s-role').value.trim();
  if (!role) {
    document.getElementById('s-role').focus();
    document.getElementById('s-role').style.borderColor = '#dc2626';
    return;
  }

  profile = {
    role: role,
    level: document.getElementById('s-level').value,
    skills: document.getElementById('s-skills').value.trim() || 'General professional skills',
    lang: document.getElementById('s-lang').value
  };

  document.getElementById('header-role').textContent = `${role} ¬∑ ${profile.level}`;
  document.getElementById('setup-overlay').style.display = 'none';
  initSpeech();
}

function changeRole() {
  // Reset & show setup again
  document.getElementById('setup-overlay').style.display = 'flex';
  stopListening();
}

// ===== SPEECH =====
function initSpeech() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById('no-support').style.display = 'block';
    document.getElementById('listen-btn').disabled = true;
    document.getElementById('listen-btn').style.opacity = '0.5';
    return false;
  }

  recognition = new SR();

  // Language mapping
  const langMap = {
    'English': 'en-US',
    'Filipino / Tagalog': 'fil-PH',
    'Taglish (mix of English and Tagalog)': 'en-PH'
  };

  recognition.lang = langMap[profile.lang] || 'en-US';
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.maxAlternatives = 3; // get multiple alternatives for better accuracy

  recognition.onstart = () => {
    setStatus('listening');
    finalTranscript = '';
    interimBuffer = '';
    document.getElementById('transcript-area').innerHTML = `
      <span class="placeholder-text">
        <div class="wave"><span></span><span></span><span></span><span></span><span></span></div>
        Listening... play the question now
      </span>`;
    // Safety max wait timer
    clearTimeout(minLengthTimer);
    minLengthTimer = setTimeout(() => {
      if (isListening && finalTranscript.trim().split(' ').length >= MIN_WORDS_TO_PROCESS) {
        stopListening();
        generateAnswer(finalTranscript.trim());
      }
    }, MAX_WAIT_TIME);
  };

  recognition.onresult = (e) => {
    let interim = '';
    let totalConf = 0, confCount = 0;

    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        // Pick best alternative
        const best = e.results[i][0];
        finalTranscript += best.transcript + ' ';
        if (best.confidence > 0) {
          totalConf += best.confidence;
          confCount++;
        }
      } else {
        // Show interim results immediately for fast visual feedback
        interim += e.results[i][0].transcript;
      }
    }

    // Update confidence badge
    if (confCount > 0) {
      const avgConf = Math.round((totalConf / confCount) * 100);
      document.getElementById('conf-badge').textContent = avgConf + '% match';
    }

    const display = (finalTranscript + interim).trim();
    if (display) {
      document.getElementById('transcript-area').innerHTML =
        `<span style="font-family:var(--serif);font-size:17px;line-height:1.6">${display}</span>`;
    }

    // Smart silence detection - only trigger if we have enough words
    // and wait patiently for the person to finish speaking
    clearTimeout(silenceTimer);
    const wordCount = finalTranscript.trim().split(/\s+/).filter(w => w.length > 0).length;
    
    if (wordCount >= MIN_WORDS_TO_PROCESS) {
      // Check if transcript ends with sentence-ending punctuation or question mark
      const cleaned = finalTranscript.trim();
      const endsWithQuestion = /[?!.]$/.test(cleaned) || 
        /\b(right|correct|think|tell me|explain|describe|would you|can you|could you|have you|did you|do you|are you|were you|is there|what|how|why|when|where|who)\b.{0,30}$/i.test(cleaned);
      
      // Wait longer if no clear sentence end detected
      const waitTime = endsWithQuestion ? 1800 : SILENCE_AFTER_SPEECH;
      
      silenceTimer = setTimeout(() => {
        if (isListening && finalTranscript.trim().split(/\s+/).length >= MIN_WORDS_TO_PROCESS) {
          stopListening();
          generateAnswer(finalTranscript.trim());
        }
      }, waitTime);
    }
  };

  recognition.onerror = (e) => {
    if (e.error === 'no-speech') {
      // Don't stop on no-speech, just keep listening patiently
      return;
    }
    if (e.error === 'not-allowed') {
      setStatus('error');
      document.getElementById('transcript-area').innerHTML =
        '<span class="placeholder-text" style="color:#dc2626">‚ùå Mic blocked. Please allow microphone and refresh.</span>';
      stopListening();
    }
    if (e.error === 'network') {
      // Try to restart on network error
      if (isListening) {
        setTimeout(() => { try { recognition.start(); } catch(ex) {} }, 500);
      }
    }
  };

  recognition.onend = () => {
    if (isListening) {
      // Seamless restart - no gap in listening
      try { recognition.start(); } catch(e) {}
    }
  };

  return true;
}

function toggleListening() {
  if (!recognition) { if (!initSpeech()) return; }
  if (!isListening) startListening();
  else { stopListening(); if (finalTranscript.trim().length > 5) generateAnswer(finalTranscript.trim()); }
}

function startListening() {
  isListening = true;
  finalTranscript = '';
  interimBuffer = '';
  clearTimeout(silenceTimer);
  clearTimeout(minLengthTimer);
  try { recognition.start(); } catch(e) {}
  document.getElementById('listen-btn').className = 'listen-btn stop';
  document.getElementById('listen-icon').textContent = '‚èπ';
  document.getElementById('listen-label').textContent = 'Stop & Get Answer';
  document.getElementById('conf-badge').textContent = '';
  setStatus('listening');
}

function stopListening() {
  isListening = false;
  clearTimeout(silenceTimer);
  clearTimeout(minLengthTimer);
  try { recognition.stop(); } catch(e) {}
  document.getElementById('listen-btn').className = 'listen-btn start';
  document.getElementById('listen-icon').textContent = 'üéôÔ∏è';
  document.getElementById('listen-label').textContent = 'Start Listening';
  setStatus('ready');
}

function setStatus(s) {
  const pill = document.getElementById('status-pill');
  const text = document.getElementById('status-text');
  pill.className = 'status-pill' + (s === 'listening' ? ' active' : '');
  text.textContent = s === 'listening' ? 'Listening...' : s === 'error' ? 'Error' : 'Ready';
}

// ===== MANUAL =====
function toggleManual() {
  manualVisible = !manualVisible;
  document.getElementById('manual-area').className = 'manual-area' + (manualVisible ? ' visible' : '');
  if (manualVisible) setTimeout(() => document.getElementById('manual-q').focus(), 50);
}

function submitManual() {
  const q = document.getElementById('manual-q').value.trim();
  if (!q) return;
  document.getElementById('transcript-area').innerHTML =
    `<span style="font-family:var(--serif);font-size:17px;line-height:1.6">${q}</span>`;
  document.getElementById('manual-q').value = '';
  toggleManual();
  generateAnswer(q);
}

// ===== AI ANSWER =====
async function generateAnswer(question) {
  currentQuestion = question;
  qCount++;

  const card = document.getElementById('answer-card');
  card.className = 'card answer-card visible fadein';
  document.getElementById('answer-loading').style.display = 'flex';
  document.getElementById('answer-body').className = 'answer-body';
  document.getElementById('q-num').textContent = `Q${qCount}`;

  const langInstruction = profile.lang === 'English'
    ? 'Answer in natural English.'
    : profile.lang === 'Filipino / Tagalog'
    ? 'Answer in natural Filipino/Tagalog.'
    : 'Answer in Taglish (mix of English and Tagalog naturally).';

  const prompt = `You are an expert interview coach helping a real job applicant answer interview questions live during an actual interview.

CANDIDATE PROFILE:
- Position applying for: ${profile.role}
- Experience level: ${profile.level}
- Skills / Background: ${profile.skills}

INTERVIEW QUESTION ASKED: "${question}"

${langInstruction}

CRITICAL RULES:
- The answer MUST directly address the SPECIFIC question asked ‚Äî do NOT give a generic answer
- Use the candidate's actual skills (${profile.skills}) naturally in the answer when relevant
- Sound like a real human speaking, not a robot or essay
- For behavioral questions (tell me about, describe a time, how do you handle), use STAR method briefly
- For technical questions about their skills, be confident and specific
- keyPoints must be SPECIFIC to this exact question, not generic interview tips
- fullAnswer must DIRECTLY answer what was asked in 60-90 words

Respond ONLY with valid JSON ‚Äî no markdown, no extra text:
{
  "keyPoints": ["specific point 1 about this question", "specific point 2", "specific point 3"],
  "fullAnswer": "Natural spoken answer that directly addresses the question. Use I-statements. Reference actual skills when relevant. Sound genuine."
}`;

  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        messages: [{ role: "user", content: prompt }]
      })
    });

    const data = await res.json();
    const raw = data.content?.[0]?.text || '';
    const clean = raw.replace(/```json|```/g, '').trim();
    const parsed = JSON.parse(clean);
    currentAnswer = parsed;
    showAnswer(parsed);
    addHistory(question, parsed);

  } catch(err) {
    const fallback = buildFallback(question);
    currentAnswer = fallback;
    showAnswer(fallback);
    addHistory(question, fallback);
  }
}

function showAnswer(data) {
  document.getElementById('answer-loading').style.display = 'none';
  document.getElementById('key-points-list').innerHTML =
    data.keyPoints.map(p => `<li>${p}</li>`).join('');
  document.getElementById('full-answer-text').textContent = data.fullAnswer;
  document.getElementById('answer-body').className = 'answer-body visible fadein';
}

function buildFallback(q) {
  const ql = q.toLowerCase();
  const role = profile.role;
  const isEntry = profile.level.includes('Fresh') || profile.level.includes('Junior');

  if (ql.includes('tell me about yourself') || ql.includes('introduce')) {
    return {
      keyPoints: [
        `${isEntry ? 'Fresh graduate' : 'Experienced professional'} applying for ${role}`,
        `Strong foundation in ${profile.skills.split(',')[0] || 'relevant skills'}`,
        "Eager to contribute and grow with the team"
      ],
      fullAnswer: `I'm ${isEntry ? 'a fresh graduate' : 'a professional'} with a background in ${profile.skills.split(',').slice(0,2).join(' and ')}. I'm applying for the ${role} position because I'm genuinely passionate about this field and I believe my skills align well with what you're looking for. I'm ${isEntry ? 'excited to learn and grow' : 'ready to bring real value'} to your team.`
    };
  }

  if (ql.includes('strength')) {
    return {
      keyPoints: [
        "Detail-oriented and thorough in every task",
        "Fast learner who adapts quickly to new tools",
        "Strong communication and teamwork skills"
      ],
      fullAnswer: `One of my biggest strengths is being detail-oriented ‚Äî I make sure every task is done thoroughly. I'm also a fast learner; I pick up new tools and processes quickly. And I communicate well with teammates, which helps keep projects moving smoothly. I think these qualities make me a reliable person on any team.`
    };
  }

  if (ql.includes('weakness')) {
    return {
      keyPoints: [
        `${isEntry ? 'Limited professional experience, compensated by proactive learning' : 'Can be a perfectionist, now better at balancing quality and speed'}`,
        "Actively taking courses and self-study to improve",
        "Turning weaknesses into growth opportunities"
      ],
      fullAnswer: `${isEntry ? "As a fresh graduate, my main weakness is limited real-world experience. But I've been very proactive ‚Äî I've studied, practiced, and built skills on my own. I see it as something I'm actively working on." : "I used to be a perfectionist, which sometimes slowed me down. I've learned to better balance getting things right with meeting deadlines efficiently."} I'm confident I'll continue improving with the right team and environment.`
    };
  }

  if (ql.includes('why') && (ql.includes('this job') || ql.includes('this position') || ql.includes('apply'))) {
    return {
      keyPoints: [
        `Passionate about the ${role} field`,
        "Skills and background align with this role",
        "Excited by the company's vision and culture"
      ],
      fullAnswer: `I'm applying because I'm genuinely passionate about ${role} and I believe this position is a great fit for my skills and background. I've been building my knowledge in ${profile.skills.split(',')[0] || 'this field'} and I'm excited to apply it professionally. I also admire what your company is doing and I want to be part of a team that's making a real impact.`
    };
  }

  if (ql.includes('salary') || ql.includes('expect') || ql.includes('compensation')) {
    return {
      keyPoints: [
        "Open to industry-standard salary for this role",
        "Prioritize learning, growth, and the right opportunity",
        "Flexible and willing to discuss"
      ],
      fullAnswer: `I'm open to whatever is competitive and fair for this role and industry. More than the salary, I'm focused on the opportunity to grow, contribute, and be part of a great team. That said, I'm happy to discuss compensation and I'm sure we can find something that works well for both sides.`
    };
  }

  if (ql.includes('5 years') || ql.includes('future') || ql.includes('goal') || ql.includes('plan')) {
    return {
      keyPoints: [
        `Grow into a more advanced ${role} role`,
        "Continuously develop technical and leadership skills",
        "Contribute meaningfully to the company's long-term goals"
      ],
      fullAnswer: `In five years, I see myself having grown significantly as a ${role} ‚Äî with deeper expertise and hopefully taking on more responsibilities. I want to keep developing my skills, stay updated with industry trends, and contribute to the company's growth in a meaningful way. I'm excited about the journey.`
    };
  }

  // Generic
  return {
    keyPoints: [
      "Approach with enthusiasm and positivity",
      "Draw from relevant skills and experience",
      "Show eagerness to contribute and keep learning"
    ],
    fullAnswer: `That's a great question. Based on my background in ${profile.skills.split(',')[0] || 'this field'}, I'd approach this with both enthusiasm and careful thought. I always make sure to apply my skills effectively, stay open to feedback, and continuously improve. I'm confident in my ability to handle this and to grow further in the process.`
  };
}

// ===== ACTIONS =====
function regenerate() { if (currentQuestion) generateAnswer(currentQuestion); }

function copyAnswer() {
  if (!currentAnswer) return;
  const text = `KEY POINTS:\n${currentAnswer.keyPoints.map(p => '‚Ä¢ ' + p).join('\n')}\n\nFULL ANSWER:\n${currentAnswer.fullAnswer}`;
  navigator.clipboard.writeText(text);
  flash('‚úì Copied to clipboard!');
}

function nextQuestion() {
  document.getElementById('answer-card').className = 'card answer-card';
  document.getElementById('transcript-area').innerHTML =
    '<span class="placeholder-text">Ready for next question. Press <strong>Start Listening</strong>...</span>';
  document.getElementById('conf-badge').textContent = '';
  startListening();
}

function flash(msg) {
  const old = document.getElementById('flash');
  if (old) old.remove();
  const el = document.createElement('div');
  el.id = 'flash';
  el.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1a6b3c;color:#fff;padding:8px 20px;border-radius:100px;font-size:12px;font-family:var(--mono);z-index:999;';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2000);
}

// ===== HISTORY =====
function addHistory(question, answer) {
  history.unshift({ question, answer, time: new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}) });
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById('history-list');
  if (history.length === 0) {
    list.innerHTML = '<div class="history-empty">No questions yet.</div>';
    return;
  }
  list.innerHTML = history.map((h, i) => `
    <div class="history-item" onclick="restoreHistory(${i})">
      <div class="history-q">${h.question}</div>
      <div class="history-meta">${h.time} ¬∑ tap to view answer</div>
    </div>
  `).join('');
}

function restoreHistory(i) {
  const h = history[i];
  currentQuestion = h.question;
  currentAnswer = h.answer;
  document.getElementById('transcript-area').innerHTML =
    `<span style="font-family:var(--serif);font-size:17px;line-height:1.6">${h.question}</span>`;
  document.getElementById('answer-card').className = 'card answer-card visible fadein';
  document.getElementById('answer-loading').style.display = 'none';
  showAnswer(h.answer);
}

function clearHistory() { history = []; qCount = 0; renderHistory(); }

// ===== KEYBOARD =====
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
    e.preventDefault();
    if (document.getElementById('setup-overlay').style.display !== 'none' &&
        document.getElementById('setup-overlay').style.display !== '') return;
    toggleListening();
  }
  if (e.code === 'Enter' && (e.metaKey || e.ctrlKey) && e.target.id === 'manual-q') submitManual();
});
</script>
</body>
</html>
